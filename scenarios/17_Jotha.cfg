#textdomain wesnoth-Dawn_of_Thunder

[scenario]
    id=17_Jotha
    next_scenario=18_IlluvÃ¨n
    name= _ "Jotha"
    map_data="{~add-ons/dawn_of_thunder/maps/17_Jotha.map}"
    victory_when_enemies_defeated=yes
    {TURNS 37 32 27 }

    {DEFAULT_SCHEDULE}
    {SCENARIO_MUSIC vengeful.ogg}
    {EXTRA_SCENARIO_MUSIC legends_of_the_north.ogg}
    {EXTRA_SCENARIO_MUSIC lunar_cage.ogg}
    {EXTRA_SCENARIO_MUSIC breaking_the_chains.ogg}
    {EXTRA_SCENARIO_MUSIC wanderer.ogg}
    {STARTING_VILLAGES 2 6}
    {STARTING_VILLAGES 3 4}
    {STARTING_VILLAGES 4 5}

    [story]
        [part]
            story= _ "They rested only a few hours. Fiannon could nearly hear the clock ticking, and Pelagius was pressing them to continue as soon as possible. When they finally arrived at Jotha, the vultures were already circling above it."
            background=story/map3.png
        [/part]
    [/story]
    {BIGMAP_JOTHA}

    [side]
        side=1
        controller=human
        team_name=1
        user_team_name= _ "Aethen's representants"

        type=Elvish Thunderer
        id=Fiannon
        name= _ "Fiannon"
        profile=portraits/Fiannon.png
        canrecruit=yes
        unrenamable=yes
        recruit=""
        extra_recruit=Elvish Fighter,Elvish Archer,Elvish Shaman,Elvish Scout

        {GOLD 290 220 150}
        {INCOME 2 0 -2}
        {FLAG_VARIANT sylvan}
    [/side]
    [side]
        side=2
        controller=ai
        team_name=1
        user_team_name= _ "Mermen"

        type=Merman Warrior King
        id=mermenking
        # wmllint: local spelling Kaspius
        name= _ "Kai Kaspius"
        canrecruit=yes
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_RESILIENT}
            {TRAIT_SLOW}
        [/modifications]
        recruit="Merman Warrior, Mermaid Priestess, Merman Netcaster, Mermaid Enchantress, Merman Spearman, Merman Brawler, Merman Citizen"

        {GOLD 250 225 200}
        {INCOME 3 6 9}
        {FLAG_VARIANT knalgan}

        [unit]
            id=mermaid
            type=Mermaid Diviner
            # wmllint: local spelling Eruadne
            name= _ "Queen Eruadne"
            side=2
            canrecruit=yes
            [modifications]
                {TRAIT_RESILIENT}
                {TRAIT_INTELLIGENT}
            [/modifications]
            x,y=32,5
        [/unit]
        [ai]
            grouping=defensive
            aggression={ON_DIFFICULTY 0.3 0.2 0.1} # (less than the default of 0.4}
            caution={ON_DIFFICULTY 0.9 0.7 0.5} # (more than the default of 0.25)
            retreat_factor={ON_DIFFICULTY 0.58 0.47 0.36} # (more than the default of 0.25)
            retreat_enemy_weight={ON_DIFFICULTY 4.4 3.3 2.2} # (more than the default of 1.0)
            leader_aggression="-5.5"
            support_villages=yes
            [goal]
                name=protect_unit
                [criteria]
                    id=mermenking
                [/criteria]
                protect_radius={ON_DIFFICULTY 9 8 7}
                value={ON_DIFFICULTY 12 11 10}
            [/goal]
            [goal]
                name=protect_unit
                [criteria]
                    id=mermaid
                [/criteria]
                protect_radius={ON_DIFFICULTY 8 7 6}
                value={ON_DIFFICULTY 9 8 7}
            [/goal]
            [goal]
                name=protect_unit
                [criteria]
                    side=1
                    id=mermen
                    canrecruit=yes
                [/criteria]
                protect_radius={ON_DIFFICULTY 9 8 7}
                value={ON_DIFFICULTY 6 5 4}
            [/goal]
            [goal]
                name=protect_location
                [criteria]
                    x,y=32,9
                [/criteria]
                protect_radius=3
                value={ON_DIFFICULTY 4 3 2}
            [/goal]
            [avoid]
                x=13-15
                y=2-4
                [or]
                    x=15-17
                    y=23-25
                [/or]
            [/avoid]
        [/ai]
    [/side]
    [side]
        side=3
        controller=ai
        team_name=2
        user_team_name= _ "Orcs"

        type=Orcish Sovereign
        id=orc
        name= _ "Worthag"
        canrecruit=yes
        recruit="Orcish Warrior,Goblin Knight,Goblin Pillager,Orcish Crossbowman,Orcish Assassin,Troll,Troll Rocklobber,Orcish Warlord,Sea Orc"
        {GOLD 350 425 500}
        {INCOME 5 10 15}
        {FLAG_VARIANT6 ragged}
        [ai]
            recruitment_more="Sea Orc"
        [/ai]
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 ("Orcish Warlord") 2}
    [side]
        side=4
        controller=ai
        team_name=2
        user_team_name= _ "Nagas"

        type=Naga Myrmidon
        id=naga
        name= _ "Ragziss"
        canrecruit=yes
        recruit="Naga Warrior, Naga Marksman, Naga Warden, Naga Ophidian, Naga Ringcaster, Naga Shield Guard"

        {GOLD 250 300 350}
        {INCOME 5 10 15}
        {FLAG_VARIANT6 ragged}
        [ai]
            scout_village_targeting=4.4
            village_value=2.2
        [/ai]
        {LOYAL_UNIT 4 (Naga Sentinel) 19 2}
        {GUARDIAN}
    [/side]
    [side]
        side=5
        controller=ai
        team_name=2
        user_team_name= _ "???"

        no_leader=yes

        {GOLD 150 200 250}
        {INCOME 0 0 0}
        {FLAG_VARIANT6 ragged}
    [/side]
    [side]
        side=6
        controller=ai
        team_name=3
        user_team_name= _ "Crabs"

        no_leader=yes

        {GOLD 0 0 0}
        {INCOME 0 0 0}
        {FLAG_VARIANT6 ragged}
    [/side]

    [event]
        name=prestart
        id=setup
        [recall]
            id=Naia
        [/recall]
        [recall]
            id=Smilvolf
        [/recall]
        [if]
            [have_unit]
                id=Smilvolf
            [/have_unit]
            [then]
                [modify_unit]
                    [filter]
                        id=Smilvolf
                        # Only do this if he is on-map and hasn't advanced yet:
                        x,y=51,12
                        type=Northguard Braveheart
                    [/filter]
                    [object]
                        id=s17_Smilvolf_HP
                        duration=scenario
                        silent=yes
                        [effect]
                            apply_to=hitpoints
                            increase={ON_DIFFICULTY 4 2 1}
                            heal_full=yes
                            increase_total={ON_DIFFICULTY 4 2 1}
                        [/effect]
                    [/object]
                [/modify_unit]
            [/then]
            [else]
                [recall]
                    role=Advisor
                    x,y=53,10
                [/recall]
            [/else]
        [/if]
        [recall]
            id=Thindromli
        [/recall]
        [recall]
            id=mermen
        [/recall]
        [recall]
            id=Alasar
        [/recall]
        [recall]
            id=Limwen
        [/recall]
        [modify_unit]
            [filter]
                side=1
            [/filter]
            facing=nw
        [/modify_unit]
#ifdef EASY
        [terrain]
            x,y=53,10
            terrain=Ke
        [/terrain]
#endif
        [set_variable]
            name=turtles_found
            value=no
        [/set_variable]
        [set_variable]
            name=troll_triggered
            value=no
        [/set_variable]
        [set_variable]
            name=armor_taken
            value=no
        [/set_variable]
        [set_variable]
            name=winning_conditions
            value=0
        [/set_variable]
        [set_variable]
            name=conditions_left
            value=3
        [/set_variable] #
        {PLACE_IMAGE "scenery/nest-empty.png" 46 2 }
        [terrain]
            x,y=46,2
            layer=overlay
            terrain="^Kov"
        [/terrain]
        {PLACE_IMAGE "units/trolls/whelp-defend-2.png~RC(magenta>green)" 47 26 }
        {PLACE_IMAGE items/cage.png 47 26 }
        {PLACE_IMAGE items/armour-merman.png 32 6 }
        {LOYAL_UNIT 2 (Merman Hoplite) 27 6 }
        {GUARDIAN}
        {LOYAL_UNIT 2 (Merman Hoplite) 36 5 }
        {GUARDIAN}
        {LOYAL_UNIT 2 (Merman Hoplite) 37 12 }
        {GUARDIAN}
        {LOYAL_UNIT 2 (Merman Hoplite) 26 10 }
        {GUARDIAN}
        {LOYAL_UNIT 2 (Merman Hoplite) 31 14 }
        {GUARDIAN}
        {LOYAL_UNIT 2 (Merman Hoplite) 33 14 }
        {GUARDIAN}
        {LOYAL_UNIT 2 (Merman Hoplite) 32 3 }
        {GUARDIAN}
        {LOYAL_UNIT 2 (Merman Hoplite) 38 9 }
        {GUARDIAN}
        [modify_unit]
            [filter]
                side=2
            [/filter]
            [status]
                slowed=yes
            [/status]
        [/modify_unit]
        [micro_ai]
            side=2
            ai_type=goto
            action=add
            [filter]
                id=mermaid
            [/filter]
            [filter_location]
                [filter]
                    id=mermaid
                [/filter]
            [/filter_location]
        [/micro_ai]
        [micro_ai]
            side=4
            ai_type=goto
            action=add
            [filter]
                id=naga
            [/filter]
            [filter_location]
                [filter]
                    id=naga
                [/filter]
            [/filter_location]
        [/micro_ai]
        [object]
            [filter]
                id=mermenking
            [/filter]
            name= _ "Storm Trident"
            image=items/storm-trident.png
            duration=forever
            description= _ "This trident allows a merman to shoot electric bolts at his enemies!"
            silent=yes
            [effect]
                apply_to=new_attack
                name="storm trident"
                description= _ "storm trident"
                icon=attacks/lightning.png
                type=fire
                range=ranged
                [specials]
                    {WEAPON_SPECIAL_MAGICAL}
                [/specials]
                damage=14
                number=3
            [/effect]

            {LIGHTNING_ANIMATION "storm trident" 1}
            {LIGHTNING_ANIMATION "storm trident" 2}
            {LIGHTNING_ANIMATION "storm trident" 3}
        [/object]

        # Crabs section.
        {VARIABLE seen_crabs 0}
        [store_locations]
#ifdef EASY
            terrain=Ds, Dd^Esd, Dd^Ftd
#else
            terrain=D*^*, Hd, D*
#endif
            [not]
                terrain=*^V*
                [or]
                    x,y=32,9
                    radius=5
                [/or]
            [/not]
            variable=sandy_places
        [/store_locations]
        {FOREACH sandy_places i}
            [set_variable]
                name=spawnlevel
                rand=0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,2,3
            [/set_variable]
            [if]
                {VARIABLE_CONDITIONAL spawnlevel equals 1}
                [then]
                    [unit]
                        type="Crab"
                        x,y=$sandy_places[$i].x|,$sandy_places[$i].y|
                        side=6
                    [/unit]
                    {GUARDIAN}
                [/then]
            [/if]
            [if]
                {VARIABLE_CONDITIONAL spawnlevel equals 2}
                [then]
                    [unit]
                        type="Overgrown Crab"
                        x,y=$sandy_places[$i].x|,$sandy_places[$i].y|
                        side=6
                    [/unit]
                    {GUARDIAN}
                [/then]
            [/if]
            [if]
                {VARIABLE_CONDITIONAL spawnlevel equals 3}
                [then]
                    [unit]
                        type="Giant Crab"
                        x,y=$sandy_places[$i].x|,$sandy_places[$i].y|
                        side=6
                        canrecruit=yes
                        extra_recruit=Dust Devil,Crab Man
                    [/unit]
                    {GUARDIAN}
                [/then]
            [/if]
        {NEXT i}
        [if]
            [have_unit]
                side=6
                type="Giant Crab"
                canrecruit=yes
            [/have_unit]
            [then]
                [terrain]
                    x=46,47,47,46,45
                    y= 1, 2, 3, 3, 3
                    layer=overlay
                    terrain="^Cov"
                [/terrain]
                [gold]
                    side=6
                    amount={ON_DIFFICULTY 84 92 100}
                [/gold]
                [modify_side]
                    side=6
                    {INCOME 1 2 3}
                [/modify_side]
            [/then]
        [/if]
        {CLEAR_VARIABLE spawnlevel}
        {CLEAR_VARIABLE sandy_places}
        {BLACK_SCREEN}
        {LOCK_VIEW}
        {HIDE_UNIT}
    [/event]

    [event]
        name=start
        id=arrival_at_Jotha
        [delay]
            time=750
        [/delay]
        [interim_text]
            #po: Trailing space is needed at the end to prevent the cutoff that
            #po: happens with italicized GUI2 text
            text= _ "<i>17. Jotha </i>"
        [/interim_text]
        [clear_print]
        [/clear_print]
        [scroll_to]
            x,y=32,9
        [/scroll_to]
        [scroll_to_unit]
            id=mermenking
        [/scroll_to_unit]
        {RESET_SCREEN}
        {UNLOCK_VIEW}
        {UNHIDE_UNIT}
        [message]
            speaker=mermenking
            #po: This speech is meant to mirror Aragorn's speech from the battle at the Black Gate of Mordor in The Lord of the Rings: Return of the King.
            #po: The speech is eventually supposed to get to a point where he concludes, "...but it is not this day!" so that it ends on a rousing and inspiring note,
            #po: but instead he gets cut off before then, when he's only said the grimly realistic (and thus depressing) part:
            message= _ "Soldiers of Jotha!
The day will come where the dark will triumph over the light!
The day will come where the last merman warrior falls inside of this city's walls!
And the day will come where..."
        [/message]
        [scroll_to_unit]
            id=mermen
        [/scroll_to_unit]
        [redraw][/redraw]
        [message]
            speaker=mermen
            message= _ "Kai, Oh Kai! I brought reinforcements! Jotha is not doomed yet!"
        [/message]
        [delay]
            time=123
        [/delay]
        [scroll_to_unit]
            id=mermenking
        [/scroll_to_unit]
        [redraw][/redraw]
        [message]
            speaker=mermenking
            message= _ "Pelagius my friend! Greetings, friends! I don't know who you are, but your mere presence is great news already. We might have a chance at defending Jotha. We'll talk later, now we fight!"
        [/message]
        [scroll_to_unit]
            id=Fiannon
        [/scroll_to_unit]
        [redraw][/redraw]
        [objectives]
            side=1
            [objective]
                description= _ "Defeat all enemy leaders"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Fiannon"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Naia"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Thindromli"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Smilvolf"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Pelagius"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Kai Kaspius or Queen Eruadne"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=yes
                carryover_percentage={ON_DIFFICULTY 60 50 40}
            [/gold_carryover]
        [/objectives]
    [/event]

    [event]
        name=sighted
        first_time_only=no
        [filter]
            side=6
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [if]
            {VARIABLE_CONDITIONAL seen_crabs equals 0}
            [then]
                [message]
                    speaker=second_unit
                    message= _ "Wow, look at that crab! It looks aggressive!"
                [/message]
            [/then]
            [else]
                [redraw][/redraw]
            [/else]
        [/if]
        {VARIABLE_OP seen_crabs add 1}
    [/event]

    [event]
        name=turn 2
        id=let_Pelagius_recruit_citizens
        [scroll_to_unit]
            id=mermenking
        [/scroll_to_unit]
        [message]
            speaker=mermenking
            message= _ "Pelagius! The people of Jotha want to help in its defense. I trust you with their command."
        [/message]
        [message]
            speaker=mermenking
            message= _ "Also, I would advise you to pay attention on the beach. It is inhabited by monstrous crabs that are hard to see on the beach. They will attack you if you come too close."
        [/message]
        [if]
            {VARIABLE_CONDITIONAL seen_crabs greater_than 1}
            [then]
                [message]
                    speaker=mermen
                    message= _ "We know, we've already seen them!"
                [/message]
            [/then]
            [elseif]
                {VARIABLE_CONDITIONAL seen_crabs equals 1}
                [then]
                    [message]
                        speaker=mermen
                        message= _ "We know, we've already seen one!"
                    [/message]
                [/then]
            [/elseif]
            [else]
                [message]
                    speaker=mermen
                    message= _ "I feel honored, my liege!"
                [/message]
            [/else]
        [/if]
        [scroll_to_unit]
            id=mermen
            highlight=yes
        [/scroll_to_unit]
        {UNMAKE_HERO mermen}
        {MODIFY_UNIT id=mermen canrecruit yes}
        {MODIFY_UNIT id=mermen extra_recruit ("Merman Citizen")}
        [redraw][/redraw]
#ifdef EASY
        [message]
            speaker=mermenking
            message= _ "Feel free to use the city to recruit!"
        [/message]
        [scroll_to]
            x,y=40,10
        [/scroll_to]
        [terrain]
            x,y=40,10
            terrain=Kme
        [/terrain]
        [redraw][/redraw]
        [delay]
            time=123
        [/delay]
        [message]
            speaker=mermen
            message= _ "Ah, of course! Thank you, my liege!"
        [/message]
#endif
        # (hints about turtles and armor are in separate events later)
    [/event]

    [event]
        name=side 3 turn 5
        id=troll_timed_release
        [if]
            [have_unit]
                id=orc
            [/have_unit]
            [and]
                [variable]
                    name=troll_triggered
                    equals=no
                [/variable]
            [/and]
            [then]
                [move_unit]
                    id=orc
                    to_x=47
                    to_y=25
                [/move_unit]
                [message]
                    speaker=orc
                    message= _ "Release the Troll!"
                [/message]
                [fire_event]
                    name=troll_freed
                [/fire_event]
                [move_unit]
                    id=orc
                    to_x=47
                    to_y=24
                [/move_unit]
#ifdef EASY
                [modify_unit]
                    [filter]
                        id=orc
                    [/filter]
                    attacks_left=0
                    moves=0
                    [status]
                        slowed=yes
                    [/status]
                [/modify_unit]
#endif
            [/then]
            [else]
                # ???
            [/else]
        [/if]
    [/event]

    [event]
        name=moveto
        id=troll_moveto_release
        [filter]
            side=1
            [filter_location]
                x,y=47,26
                radius=1
            [/filter_location]
        [/filter]
        [if]
            [and]
                [variable]
                    name=troll_triggered
                    equals=no
                [/variable]
            [/and]
            [then]
                [message]
                    speaker=$unit.id
                    message= _ "I wonder what might happen if I release the troll..."
                [/message]
                [fire_event]
                    name=troll_freed
                [/fire_event]
                [message]
                    speaker=$unit.id
                    message= _ "I don't know what I expected..."
                [/message]
            [/then]
        [/if]
    [/event]

    [event]
        name=troll_freed
        id=release_the_troll
        {REMOVE_IMAGE 47 26}
        [terrain]
            x,y=47,26
            terrain=Hh
        [/terrain]
        {REDRAW}
        [unit]
            id=troll
            type=Giant Troll
            x,y=47,26
            side=3
            overlays="misc/midboss-icon.png"
        [/unit]
        [store_unit]
            [filter]
                id=troll
            [/filter]
            variable=trollish_guy
        [/store_unit]
        [message]
            speaker=troll
            message= _ "<big><b>$trollish_guy.name HUNGRY! $trollish_guy.name SMASH! $trollish_guy.name EAT!</b></big>"
        [/message]
        {CLEAR_VARIABLE trollish_guy}
        [set_variable]
            name=troll_triggered
            value=yes
        [/set_variable]
    [/event]

    [event]
        name=moveto
        id=pickup_armor
        first_time_only=no
        [filter]
            side=1
            x,y=32,6
        [/filter]
        [message]
            speaker=narrator
            image="portraits/MermanArmor.png"
            message= _ "Do you want this unit to pick up the armor?"
            [option]
                message= _ "Yes"
                [command]
                    [object]
                        id=merman_armor
                        name= _ "Merforged Armor"
                        image="portraits/MermanArmor.png"
                        duration=forever
                        #po: FIXME: this description string gets cut off after "previously" (i.e. before "unknown durability"):
                        description= _ "This armor was forged in an underwater volcano, thousands of years ago. It grants its bearer previously unknown durability."
                        cannot_use_message= _ "It seems you are not humanoid enough to use this armor"
                        [filter]
                            x,y=$x1,$y1
                            [and]
                                race=human
                                [or]
                                    race=dwarf
                                [/or]
                                [or]
                                    race=elf
                                [/or]
                                [or]
                                    race=elf2
                                [/or]
                                [or]
                                    race=fairy
                                [/or]
                                [or]
                                    race=human-northguard
                                [/or]
                                [or]
                                    race=dunefolk
                                [/or]
                            [/and]
                            [not]
                                id=Smilvolf
                            [/not]
                        [/filter]
                        [then]
                            [remove_item]
                                x,y=$x1,$y1
                            [/remove_item]
                            [message]
                                speaker=narrator
                                image="portraits/MermanArmor.png"
                                message= _ "As you put on the armor, you feel revived and refreshed. The armor weighs next to nothing and doesn't hinder you in any way."
                            [/message]
                        [/then]
                        [effect]
                            apply_to=new_ability
                            [abilities]
                                {ABILITY_REGENERATES}
                                {ABILITY_STEADFAST}
                            [/abilities]
                        [/effect]
                        [effect]
                            apply_to=hitpoints
                            increase_total=6
                            increase=6
                        [/effect]
                        [effect]
                            apply_to=resistance
                            [resistance]
                                arcane=-10
                                fire=-10
                                cold=-10
                                blade=-20
                                pierce=-20
                                impact=-20
                            [/resistance]
                        [/effect]
                    [/object]
                    [set_variable]
                        name=armor_taken
                        value=yes
                    [/set_variable]
                [/command]
            [/option]
            [option]
                message= _ "No"
                [command]
                    [allow_undo]
                    [/allow_undo]
                [/command]
            [/option]
        [/message]
    [/event]

    [event]
        name=side 5 turn 7
        id=Mal_Lirak_arrives
        [move_unit_fake]
            type=Dark Sorcerer
            x=36,35,35,33,33,29,28,25,20,19,16,16
            y=28,28,26,25,23,21,21,20,22,22,23,24
            side=5
        [/move_unit_fake]
        [unit]
            x,y=16,24
            type=Dark Sorcerer
            profile="portraits/humans/dark-adept.webp"
            name=_"Mal Lirak"
            side=5
            id=Lirak
            experience={ON_DIFFICULTY 71 72 73} # TODO: maybe save his XP in previous scenario and then add it back here?
            canrecruit=yes
            extra_recruit="Wraith, Spectre, Shadow, Ghost, Familiar"
        [/unit]
        {LIMIT_RECRUITS 5 Familiar 1}
        [redraw][/redraw]
        [message]
            speaker=Lirak
            #po: "Long time no see" is an idiomatic way of saying "It's been a long time since I last saw you"
            message= _ "Orcs! Nagas! You are taking too long for the Master's taste, so I brought some ghostly support.
Naia, long time no see! I see you are still with that elf, I heard you have been pestering M'Brin. Well, I have learned a lot since the last time we met."
        [/message]
        [message]
            speaker=Alasar
            message= _ "Not that guy again..."
        [/message]
        [message]
            speaker=Fiannon
            message= _ "We can't let him escape again! This time, we should surround him at least from three sides to be able to capture him."
        [/message]
        [modify_side]
            side=5
            user_team_name=_ "Mal Lirak"
            {GOLD 200 250 300}
            {INCOME 5 10 15}
        [/modify_side]
        [objectives]
            side=1
            [objective]
                description= _ "Defeat all enemy leaders AND"
                condition=win
            [/objective]
            [objective]
                description= _ "Surround Mal Lirak to try to capture him"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Fiannon"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Naia"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Thindromli"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Smilvolf"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Pelagius"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Kai Kaspius or Queen Eruadne"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=yes
                carryover_percentage={ON_DIFFICULTY 60 50 40}
            [/gold_carryover]
            [note]
                description= _ "Your troops assume that they can capture Mal Lirak by surrounding him from at least 3 sides."
            [/note]
        [/objectives]
    [/event]

    [event]
        name=side 2 turn 11
        id=hint_about_armor
        [if]
            [variable]
                name=armor_taken
                equals=no
            [/variable]
            [then]
                [message]
                    speaker=mermaid
                    message= _ "Heroes, we have been guarding a piece of armor in Jotha for centuries. It is humanoid, so we can't use it, but you should!"
                [/message]
            [/then]
        [/if]
    [/event]

    [event]
        name=side 2 turn 10
        id=hint_about_turtles
        [if]
            [variable]
                name=turtles_found
                equals=no
            [/variable]
            [then]
                [message]
                    speaker=mermaid
                    message= _ "Pelagius, maybe you should ask the turtles for help. Their lagoon is also endangered."
                [/message]
                [message]
                    speaker=mermen
                    message= _ "Good idea, milady!"
                [/message]
                {HIGHLIGHT_IMAGE 46 2 "items/gohere.png" "scenery/nest-empty.png"}
            [/then]
        [/if]
    [/event]

    [event]
        name=moveto
        id=meet_turtles
        first_time_only=no
        [filter]
            x,y=46,2
            side=1
        [/filter]
        [filter_condition]
            [variable]
                name=turtles_found
                equals=no
            [/variable]
        [/filter_condition]
        [if]
            [variable]
                name=unit.id
                equals=mermen
            [/variable]
            [then]
                [remove_item]
                    image="items/gohere.png"
                    x,y=46,2
                [/remove_item]
                [message]
                    speaker=mermen
                    message= _ "Turtles, I know you are here!

Show yourselves!"
                [/message]
                #wmllint: recognize turtle
                {NAMED_LOYAL_UNIT 1 (Giant Sea Turtle) 47 2 (turtle) (_"Gargantua")}
                [message]
                    speaker=turtle
                    message= _ "What do you want, merman?"
                [/message]
                [message]
                    speaker=mermen
                    message= _ "Oh time-honored Sea Turtle. We have always been friends, we've hunted between the corals together since I was young. We need your help against the invaders. Their forces are strong, and they plan on destroying everything inside of this bay, even your lagoon and the very coral reefs that support your life."
                [/message]
                [message]
                    speaker=turtle
                    message= _ "Very well, I have lived here for over 400 years. I will not have anyone take it from me. Children!"
                [/message]
                {LOYAL_UNIT 1 (Baby Sea Turtle) 47 1}
                {LOYAL_UNIT 1 (Sea Turtle) 46 1}
                {REDRAW}
                [set_variable]
                    name=turtles_found
                    value=yes
                [/set_variable]
            [/then]
            [else]
                [message]
                    speaker=mermenking
                    message= _ "Pelagius, you know the turtles better than $unit.name|, maybe you should talk to them."
                [/message]
                [move_unit]
                    to_x=46
                    to_y=3
                    id=$unit.id
                [/move_unit]
            [/else]
        [/if]
    [/event]

    [event]
        name=moveto
        id=encircle_Mal_Lirak
        first_time_only=no
        [filter]
            side=1
            [filter_adjacent]
                id=Lirak
                [filter_adjacent]
                    side=1
                    count=3
                [/filter_adjacent]
            [/filter_adjacent]
        [/filter]
        [message]
            speaker=$unit.id
            message= _ "We've got you encircled! You have nowhere to go!"
        [/message]
        [message]
            speaker=Fiannon
            message= _ "This time you won't escape us! We've got a lot of questions to ask to you!"
        [/message]
        [message]
            speaker=Naia
            message= _ "How did you get so powerful? You barely passed your midterms when you were still in the academy!"
        [/message]
        [message]
            speaker=Lirak
            message= _ "You know, Naia... Sometimes you just have to change your teacher. You are not the only one who has learned a lot.
Farewell, and good luck in your endeavor of saving Wesmere! You will soon understand what is really going on, and then we will see ourselves again!"
        [/message]
        [object]
            [filter]
                id=Lirak
            [/filter]
            [effect]
                apply_to=new_animation
                [animation]
                    apply_to=pre_teleport
                    {TELEPORT_OUT_ANIMATION}
                [/animation]
            [/effect]
        [/object]
        [animate_unit]
            flag=pre_teleport
            [filter]
                id=Lirak
            [/filter]
        [/animate_unit]
        [kill]
            id=Lirak
            fire_event=no
        [/kill]
        [delay]
            time=1000
        [/delay]
        [message]
            speaker=Thindromli
            message= _ "By Odin's beard, I thought only Silver Mages know how to teleport!"
        [/message]
        [message]
            speaker=Naia
            message= _ "I thought that as well. His teacher must be really powerful."
        [/message]
        [set_variable]
            name=winning_conditions
            add=1
        [/set_variable]
        [set_variable]
            name=conditions_left
            value="$(3 - $winning_conditions|)"
        [/set_variable]
        [if]
            [variable]
                name=winning_conditions
                equals=3
            [/variable]
            [then]
                [message]
                    race=merman
                    [not]
                        id=mermenking
                        [or]
                            id=mermaid
                        [/or]
                    [/not]
                    message= _ "Milord, with the Necromancer's disappearance, the last of the enemy forces are fleeing!"
                [/message]
                [fire_event]
                    name=victory
                [/fire_event]
            [/then]
            [else]
                [message]
                    speaker=Smilvolf
                    message= _ "We should stop talking and rather focus on the task at hand!"
                [/message]
            [/else]
        [/if]
    [/event]

    [event]
        name=victory
        id=cleanup
        [message]
            speaker=Thindromli
            message= _ "We did it!"
        [/message]
        [message]
            speaker=Smilvolf
            message= _ "It was a great victory, elf! I am honored to fight besides such a skilled tactician."
        [/message]
        [message]
            speaker=mermen
            message= _ "Fiannon, I am thankful for everything you did for us, but I have to stay here with my people. May the currents lead you into safe haven."
        [/message]
        [modify_unit]
            [filter]
                race=merman
            [/filter]
            side=2
        [/modify_unit]
        {MODIFY_UNIT id=mermen canrecruit no}
        [message]
            speaker=mermenking
            message= _ "Elves, men and dwarves, the people of Jotha are forever in your debt. Should you ever have a river, a sea or even a puddle nearby and need help, just blow into this Seashell and we will rush to your help. It is magically connected to the Kai's lifeforce and I will always hear it."
        [/message]
        [message]
            speaker=turtle
            message= _ "You have deeply impressed me. Me and my children, we will go with you."
        [/message]
        [message]
            speaker=Fiannon
            message= _ "Thank you everyone! How shall we proceed now?"
        [/message]
        [message]
            speaker=Thindromli
            message= _ "Bash 'em heads in of course!"
        [/message]
        [message]
            speaker=Smilvolf
            message= _ "I suggest to take the way through the plains. Thanks to our Rocs we can spot the enemy from afar and can take detours if needed."
        [/message]
        [message]
            speaker=Fiannon
            message= _ "There's a small settlement on the north-west edge of Wesmere. Maybe we can get some reinforcements there."
        [/message]
        [message]
            speaker=Naia
            message= _ "Onwards then, let us wrest Wesmere from the Orcish claws!"
        [/message]
        {CLEAR_VARIABLE troll_triggered}
        {CLEAR_VARIABLE armor_taken}
        {CLEAR_VARIABLE turtles_found}
        {CLEAR_VARIABLE winning_conditions}
        {CLEAR_VARIABLE conditions_left}
        {CLEAR_VARIABLE seen_crabs}
        [endlevel]
            result=victory
            bonus=yes # (to match the objectives)
            {NEW_GOLD_CARRYOVER {ON_DIFFICULTY 60 50 40}}
        [/endlevel]
    [/event]

    [event]
        name=last breath
        id=orc_leader_death
        [filter]
            id=orc
        [/filter]
        [message]
            speaker=orc
            message= _ "<small>(grunts)</small>"
        [/message]
        [kill]
            id=orc
            animate=yes
        [/kill]
        [set_variable]
            name=winning_conditions
            add=1
        [/set_variable]
        [set_variable]
            name=conditions_left
            value="$(3 - $winning_conditions|)"
        [/set_variable]
        [if]
            [variable]
                name=winning_conditions
                equals=3
            [/variable]
            [then]
                [fire_event]
                    name=victory
                [/fire_event]
            [/then]
            [else]
                [message]
                    speaker=Thindromli
                    message= _ "Only $conditions_left left!"
                [/message]
            [/else]
        [/if]
    [/event]

    [event]
        name=last breath
        id=naga_leader_death
        [filter]
            id=naga
        [/filter]
        [message]
            speaker=naga
            message= _ "Cursssse you!" # wmllint: no spellcheck
        [/message]
        [kill]
            id=naga
            animate=yes
        [/kill]
        [set_variable]
            name=winning_conditions
            add=1
        [/set_variable]
        [set_variable]
            name=conditions_left
            value="$(3 - $winning_conditions|)"
        [/set_variable]
        [if]
            [variable]
                name=winning_conditions
                equals=3
            [/variable]
            [then]
                [fire_event]
                    name=victory
                [/fire_event]
            [/then]
            [else]
                [message]
                    speaker=Thindromli
                    message= _ "Only $conditions_left left!"
                [/message]
            [/else]
        [/if]
    [/event]

    [event]
        name=last breath
        id=Kai_Kaspius_death
        [filter]
            id=mermenking
        [/filter]
        [message]
            speaker=mermaid
            message= _ "My Husband!"
        [/message]
        [message]
            speaker=mermen
            message= _ "NOO! Without our Kai, everything is lost!"
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [event]
        name=last breath
        id=Queen_Eruadne_death
        [filter]
            id=mermaid
        [/filter]
        [message]
            speaker=mermenking
            message= _ "My Husband!"
        [/message]
        [message]
            speaker=mermen
            message= _ "NOO! Without our Queen, everything is lost!"
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [event]
        name=last breath
        id=Pelagius_death
        [filter]
            id=mermen
        [/filter]
        [message]
            speaker=mermen
            message= _ "Nooo! Fiannon, promise me to save Jotha!"
        [/message]
        [message]
            speaker=Fiannon
            message= _ "We can't do it without you, Pelagius!"
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    {PEASANTDEATHS}
    {GLOBAL_EVENTS}
    {DEATHS}
[/scenario]
